<html>
<head>

</head>
<body style="margin: 1px;">
    <div style="background-color: purple; color: white; -webkit-app-region:drag;">
        Header
        <span id="groupIdInput" style="display:inline-block; margin-left:16px; font-size: xx-small; height:16px; width:60px; border-style:none;background-color: darkmagenta; color: white;"></span>
        <a id="groupIdClear" style="display:inline; cursor: pointer; margin-left:16px; font-size: small; color: white; -webkit-app-region:no-drag;">&#8663;</a>
    </div>
    <br/>
    <div>Content</div>
    <div>State<input id="textInput"/></div>
    <script>
        (async function() {
            const groupIdInput = document.querySelector('#groupIdInput');
            const groupIdClear = document.querySelector('#groupIdClear');
            const textInput = document.querySelector('#textInput');
            const finWindow = fin.Window.getCurrentSync();
            
            let { customData: { state, groupId }} =  await finWindow.getOptions();

            groupIdInput.innerText = groupId
            textInput.value = state.textInput || '';

            function setState(key, value) {
                state[key] = value;
                finWindow.updateOptions({ customData: { state, groupId }});
            }

            function setGroup(groupId) {
                finWindow.updateOptions({ customData: { state, groupId }});
            }

            finWindow.addListener('options-changed', evt => {
                let { customData: { state, groupId }} = evt.options;

                groupIdInput.innerText = groupId;
                textInput.value = state.textInput || '';
            });

            textInput.addEventListener('input', evt => setState(textInput.id, textInput.value));
            groupIdClear.addEventListener('click', () => {
                let newGroupId = fin.desktop.getUuid().substr(0,7);
                groupIdInput.innerText = newGroupId;
                setGroup(newGroupId);

                finWindow.leaveGroup();
            });
            
            window.opener && window.opener.addEventListener('beforeunload', () => finWindow.close());
        })();

    </script>
</body>
</html>